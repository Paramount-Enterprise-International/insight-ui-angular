name: Build & Publish @insight/ui from Release Tag

on:
  release:
    types: [published]

env:
  LIB_NAME: insight-ui # Angular project name: projects/insight-ui
  BUILD_BRANCH: build # Branch that will hold the built package
  MAIN_BRANCH: main # Branch to merge the release source back into

permissions:
  contents: write

jobs:
  release-build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout source at the tag created by your Release
      - name: Checkout source at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}
          fetch-depth: 0

      # 2) Extract version from tag
      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "Tag from release: $TAG"

          if [[ ! "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag '$TAG' does not look like x.y.z (e.g. 1.0.2)."
            exit 1
          fi

          echo "version=$TAG" >> "$GITHUB_OUTPUT"

      # 3) Set up Node
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 4) Install deps
      - name: Install dependencies
        shell: bash
        run: |
          rm -rf node_modules package-lock.json
          npm install

      # 5) Sync library version to tag (build artifact version)
      - name: Sync library version to tag
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Setting projects/${LIB_NAME}/package.json version to ${VERSION}"

          jq ".version = \"${VERSION}\"" "projects/${LIB_NAME}/package.json" > "projects/${LIB_NAME}/package.tmp"
          mv "projects/${LIB_NAME}/package.tmp" "projects/${LIB_NAME}/package.json"

          cat "projects/${LIB_NAME}/package.json"

      # 6) Build Angular library
      - name: Build Angular library
        shell: bash
        run: |
          npx --yes @angular/cli@20 build "$LIB_NAME" --configuration=production

      # 7) Stash dist output OUTSIDE the repo (so branch cleaning can't delete it)
      - name: Stash build artifacts to runner temp
        shell: bash
        run: |
          ART_DIR="${RUNNER_TEMP}/insight-ui-build"
          rm -rf "$ART_DIR"
          mkdir -p "$ART_DIR"

          echo "Expecting dist at: dist/${LIB_NAME}"
          ls -la dist || true
          ls -la "dist/${LIB_NAME}" || true

          if [ ! -d "dist/${LIB_NAME}" ]; then
            echo "ERROR: dist/${LIB_NAME} not found. Build output path mismatch."
            exit 1
          fi

          cp -R "dist/${LIB_NAME}/." "$ART_DIR/"
          echo "Artifacts stashed to $ART_DIR:"
          ls -la "$ART_DIR"

      # 8) Switch to build branch
      - name: Checkout or create build branch
        shell: bash
        run: |
          git fetch origin "${BUILD_BRANCH}" || true

          if git ls-remote --exit-code --heads origin "${BUILD_BRANCH}" >/dev/null 2>&1; then
            git switch "${BUILD_BRANCH}"
            git pull origin "${BUILD_BRANCH}" --rebase || true
          else
            git switch -c "${BUILD_BRANCH}"
          fi

      # 9) Clean build branch workspace (tracked + untracked)
      - name: Clean build branch workspace
        shell: bash
        run: |
          echo "Cleaning build branch workspace..."
          # Remove tracked files
          git rm -rf . || true
          # Remove untracked files too
          git clean -fdx

      # 10) Copy artifacts from runner temp into branch root
      - name: Copy artifacts into build branch
        shell: bash
        run: |
          ART_DIR="${RUNNER_TEMP}/insight-ui-build"

          echo "Copying artifacts from $ART_DIR into branch root..."
          if [ ! -d "$ART_DIR" ]; then
            echo "ERROR: Artifact dir missing: $ART_DIR"
            exit 1
          fi

          cp -R "$ART_DIR/." .

          echo "Resulting tree on build branch:"
          ls -la

          # Safety: ensure we did not publish source folders
          rm -rf node_modules release-tmp dist projects src || true

      # 11) Commit & push build branch
      - name: Commit and push build branch
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          if git diff --cached --quiet; then
            echo "ðŸŸ¡ No changes to commit on ${BUILD_BRANCH}"
          else
            git commit -m "release: @insight/ui v${VERSION}"
            git push origin "${BUILD_BRANCH}" --force
          fi

      # 12) Move version tag + latest to this build commit
      - name: Update tags to point at built artifacts
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git fetch --tags origin

          git tag -f "$VERSION"
          git push origin "$VERSION" --force

          git tag -f latest
          git push origin latest --force

      # 13) Merge release source branch back into main (optional)
      - name: Merge release source branch back into main
        shell: bash
        run: |
          SRC_REF="${{ github.event.release.target_commitish }}"
          MAIN_BRANCH="${{ env.MAIN_BRANCH }}"

          echo "Release target_commitish: $SRC_REF"
          echo "Main branch: $MAIN_BRANCH"

          if [ "$SRC_REF" = "$MAIN_BRANCH" ]; then
            echo "Release source is already '$MAIN_BRANCH'. Nothing to merge."
            exit 0
          fi

          git fetch origin "$MAIN_BRANCH"

          if git ls-remote --exit-code origin "$SRC_REF" >/dev/null 2>&1; then
            git fetch origin "$SRC_REF":"$SRC_REF"
          fi

          if git show-ref --quiet "refs/heads/$MAIN_BRANCH"; then
            git switch "$MAIN_BRANCH"
          else
            git switch -c "$MAIN_BRANCH" "origin/$MAIN_BRANCH"
          fi

          git merge --no-ff "$SRC_REF" -m "chore: merge release $SRC_REF into $MAIN_BRANCH"
          git push origin "$MAIN_BRANCH"
