name: Build & Publish @insight/ui from Release Tag

on:
  release:
    types: [published] # Only when YOU publish a Release in GitHub UI

env:
  LIB_NAME: insight-ui # Angular project name: projects/insight-ui
  BUILD_BRANCH: build # Branch that will hold the built package

permissions:
  contents: write # Needed to push branches & tags

jobs:
  release-build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout source at the tag created by your Release
      - name: Checkout source at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }} # e.g. "1.0.2"
          fetch-depth: 0

      # 2) Extract version from tag (tag == version, e.g. "1.0.2")
      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "Tag from release: $TAG"

          # Basic semver-ish validation
          if [[ ! "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag '$TAG' does not look like x.y.z (e.g. 1.0.2)."
            exit 1
          fi

          echo "version=$TAG" >> "$GITHUB_OUTPUT"

      # 3) Set up Node
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # cache: npm

      # 4) Install deps
      - name: Install dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install

      # 5) Sync library version to tag (for the built artifact only)
      - name: Sync library version to tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Setting projects/${LIB_NAME}/package.json version to ${VERSION}"

          jq ".version = \"${VERSION}\"" "projects/${LIB_NAME}/package.json" > "projects/${LIB_NAME}/package.tmp"
          mv "projects/${LIB_NAME}/package.tmp" "projects/${LIB_NAME}/package.json"

          cat "projects/${LIB_NAME}/package.json"

      # 6) Build Angular library
      - name: Build Angular library
        run: |
          npx --yes @angular/cli@20 build "$LIB_NAME" --configuration=production

      # 7) Copy dist output to a temporary folder
      - name: Prepare build artifacts
        run: |
          rm -rf release-tmp
          mkdir -p release-tmp
          cp -R "dist/${LIB_NAME}/." release-tmp/
          echo "Artifacts in release-tmp:"
          ls -la release-tmp

      # 8) Checkout / create the build branch
      - name: Checkout or create build branch
        run: |
          git fetch origin "$BUILD_BRANCH" || true

          if git show-ref --quiet "refs/heads/$BUILD_BRANCH"; then
            git switch "$BUILD_BRANCH"
          else
            git switch -c "$BUILD_BRANCH"
          fi

      # 9) Replace build branch contents with artifacts
      - name: Replace build branch contents with artifacts
        run: |
          # Remove everything tracked in this branch
          git rm -rf . || true

          # Copy built files from temp into root
          cp -R release-tmp/* .

          # Safety: remove any node_modules if they ended up here
          rm -rf node_modules
          find . -type d -name "node_modules" -prune -exec rm -rf {} \;

          # Optional: remove stray .ts (non-declaration) if any
          find . -type f -name '*.ts' ! -name '*.d.ts' -delete || true

          echo "Resulting tree on $BUILD_BRANCH:"
          ls -la

      # 10) Commit & push build branch
      - name: Commit and push build branch
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          if git diff --cached --quiet; then
            echo "ðŸŸ¡ No changes to commit on $BUILD_BRANCH"
          else
            git commit -m "release: @insight/ui v${VERSION}"
            git push origin "$BUILD_BRANCH" --force
          fi

      # 11) Move version tag + latest to this build commit
      - name: Update tags to point at built artifacts
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Moving tag '${VERSION}' to current build on branch ${BUILD_BRANCH}"

          # Ensure we have all tags
          git fetch --tags origin

          # Move the version tag to this commit
          git tag -f "$VERSION"
          git push origin "$VERSION" --force

          # Optional: maintain a moving 'latest' tag as well
          echo "Updating 'latest' tag"
          git tag -f latest
          git push origin latest --force
