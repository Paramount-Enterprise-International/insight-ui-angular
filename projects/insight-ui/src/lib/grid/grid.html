<!-- grid.html -->
<!--
 IGrid
 Version: 1.22.0
-->

<div
  class="i-grid-viewport"
  [style.height.px]="bodyHeight || null"
  [style.max-height.px]="bodyMaxHeight || null">
  <!-- HEADER -->
  @if (columns.length) {
    <i-grid-header-row>
      <!-- Selection header column:
           - Shown normally for flat grid / single selection
           - Hidden for tree + multiple (tree has its own column)
      -->
      @if (selectionMode && !(treeEnabled && selectionMode === 'multiple')) {
        <i-grid-header-cell
          class="i-grid-selection-cell i-grid-selection-cell--header i-grid-header-cell--frozen"
          [fixedWidth]="selectionColumnWidth"
          [style.position]="'sticky'"
          [style.left.px]="0">
          @if (selectionMode === 'multiple') {
            <input
              type="checkbox"
              [checked]="allVisibleSelected"
              [indeterminate]="someVisibleSelected"
              (click)="$event.stopPropagation()"
              (change)="onToggleAllVisible()" />
          }
        </i-grid-header-cell>
      }

      <!-- Tree control header column (toggler/checkbox lives here, not in data column) -->
      @if (treeEnabled) {
        <i-grid-header-cell
          class="i-grid-tree-cell i-grid-tree-cell--header i-grid-header-cell--frozen"
          [fixedWidth]="treeColumnWidth"
          [style.position]="'sticky'"
          [style.left.px]="
            selectionMode && !(treeEnabled && selectionMode === 'multiple')
              ? selectionColumnWidth
              : 0
          ">
          @if (selectionMode === 'multiple') {
            <input
              type="checkbox"
              class="i-grid-tree-header-checkbox"
              [checked]="allVisibleSelected"
              [indeterminate]="someVisibleSelected"
              (click)="$event.stopPropagation()"
              (change)="onToggleAllVisible()" />
          }
        </i-grid-header-cell>
      }

      @if (showNumberColumnEffective) {
        <i-grid-header-cell
          class="i-grid-number-cell i-grid-number-cell--header"
          [column]="numberColumn"
          [style.position]="hasFrozenColumns ? 'sticky' : null"
          [style.left.px]="
            hasFrozenColumns
              ? (selectionMode && !(treeEnabled && selectionMode === 'multiple')
                  ? selectionColumnWidth
                  : 0) + (treeEnabled ? treeColumnWidth : 0)
              : null
          ">
          {{ numberColumn.title }}
        </i-grid-header-cell>
      }

      @for (col of columns; track col; let colIndex = $index) {
        @if (col.headerDef; as tmpl) {
          <!-- Custom header: user owns the <i-grid-header-cell> inside -->
          <ng-container [ngTemplateOutlet]="tmpl"></ng-container>
        } @else {
          <!-- Default header -->
          <i-grid-header-cell
            [column]="col"
            [class.i-grid-header-cell--auto]="col.isAuto">
            {{ col.title || col.fieldName }}
          </i-grid-header-cell>
        }
      }
    </i-grid-header-row>
  }

  <!-- ROWS -->
  @for (row of renderedData; track rowIndex; let rowIndex = $index) {
    <i-grid-row
      (click)="onRowClicked(row)"
      [class.i-grid-selection-row]="!!selectionMode">
      <!-- Selection column:
           - Only when not in tree + multiple mode
           - In tree + multiple, checkbox is in the tree column
      -->
      @if (selectionMode && !(treeEnabled && selectionMode === 'multiple')) {
        <i-grid-cell
          class="i-grid-selection-cell i-grid-selection-cell--body"
          [fixedWidth]="selectionColumnWidth"
          (click)="$event.stopPropagation()"
          [style.position]="'sticky'"
          [style.left.px]="0">
          @if (selectionMode === 'multiple') {
            <input
              type="checkbox"
              [checked]="getRowChecked(row)"
              [indeterminate]="getRowIndeterminate(row)"
              (change)="onRowSelectionToggle(row)" />
          } @else if (selectionMode === 'single') {
            <input
              type="radio"
              [name]="singleSelectionName"
              [checked]="isRowSelected(row)"
              (change)="onRowSelectionToggle(row)" />
          }
        </i-grid-cell>
      }

      <!-- Tree control column -->
      @if (treeEnabled) {
        <i-grid-cell
          class="i-grid-tree-cell i-grid-tree-cell--body"
          [fixedWidth]="treeColumnWidth"
          (click)="$event.stopPropagation()"
          [style.position]="'sticky'"
          [style.left.px]="
            selectionMode && !(treeEnabled && selectionMode === 'multiple')
              ? selectionColumnWidth
              : 0
          ">
          <span
            class="i-grid-tree-cell__content"
            [style.padding-left.px]="8 + getRowLevel(row) * treeIndent">
            @if (hasChildren(row)) {
              <i-button
                class="i-grid-tree-toggle"
                size="2xs"
                variant="outline"
                [icon]="isExpanded(row) ? 'down' : 'next'"
                (onClick)="onTreeToggle(row, $event)">
              </i-button>
            } @else {
              <span class="i-grid-tree-spacer"></span>
            }

            @if (selectionMode === 'multiple') {
              <input
                type="checkbox"
                class="i-grid-tree-checkbox"
                [checked]="getRowChecked(row)"
                [indeterminate]="getRowIndeterminate(row)"
                (click)="$event.stopPropagation()"
                (change)="onRowSelectionToggle(row)" />
            }
          </span>
        </i-grid-cell>
      }

      @if (showNumberColumnEffective) {
        <i-grid-cell
          class="i-grid-number-cell i-grid-number-cell--body"
          [column]="numberColumn"
          (click)="$event.stopPropagation()"
          [style.position]="hasFrozenColumns ? 'sticky' : null"
          [style.left.px]="
            hasFrozenColumns
              ? (selectionMode && !(treeEnabled && selectionMode === 'multiple')
                  ? selectionColumnWidth
                  : 0) + (treeEnabled ? treeColumnWidth : 0)
              : null
          ">
          <span class="i-grid-cell__content">
            {{ getRowNumber(rowIndex) }}
          </span>
        </i-grid-cell>
      }

      @for (col of columns; track col; let colIndex = $index) {
        @if (col.cellDef; as tmpl) {
          <!-- Custom cell: template root should be <i-grid-cell> -->
          <ng-container
            [ngTemplateOutlet]="tmpl"
            [ngTemplateOutletContext]="{
              $implicit: row,
              row: row,
              index: rowIndex,
              column: col,
            }">
          </ng-container>
        } @else {
          <!-- Default cell: show highlighted row[fieldName] (for data-backed columns) -->
          <i-grid-cell [column]="col" [class.i-grid-cell--auto]="col.isAuto">
            <span
              class="i-grid-cell__content"
              [innerHTML]="
                col.fieldName
                  ? ($any(row)[col.fieldName]
                    | highlightSearch: currentFilterText)
                  : ''
              ">
            </span>
          </i-grid-cell>
        }
      }
    </i-grid-row>
  }
</div>

@if (hasPagination) {
  <div class="i-grid-footer">
    <i-paginator
      [length]="totalLength"
      [pageIndex]="pageIndex"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (pageChange)="onPageChange($event)">
    </i-paginator>
  </div>
}
